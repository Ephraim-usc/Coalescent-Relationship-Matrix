#!/usr/bin/env python

### importing packages
import argparse
import os
import pandas as pd
import pickle
import datetime
import tsinfer
import tsdate

### importing egrm
from egrm import *

### parse arguments
parser=argparse.ArgumentParser()

parser.add_argument('--out', type = str, help='output directory')
parser.add_argument('--name', type = str, help='output file name')
parser.add_argument('--all', help='run all steps', action='store_true')
parser.add_argument('--gcta', help='run gcta analysis', action='store_true')
parser.add_argument('--relate', help='run relate tree reconstruction', action='store_true')
parser.add_argument('--tsinfer', help='run tsinfer tree reconstruction', action='store_true')
parser.add_argument('--l', type = int, help='chromosome length')
parser.add_argument('--N', type = int, help='population size')
parser.add_argument('--mutation_rate', type = float, help='mutation rate')
parser.add_argument('--recomb_rate', type = float, help='recombination rate')
parser.add_argument('--cas_ratio', type = float, help='M_cas / M')
parser.add_argument('--obs_ratio', type = float, help='M_obs / M_5')
parser.add_argument('--h2g', type = float, help='heritability')
parser.add_argument('--Alpha', type = float, help='Alpha -- causal probability parameter')
parser.add_argument('--Beta', type = float, help='Beta -- observation probability parameter')

args = vars(parser.parse_args())
args = dict((k,v) for k,v in args.items() if v is not None)

out = args.pop("out")
if not os.path.exists(out):
  os.mkdir(out)
os.chdir(out)

name = args.pop("name")
run_all = args.pop("all")
run_gcta = args.pop("gcta")
run_relate = args.pop("relate")
run_tsinfer = args.pop("tsinfer")

if run_all:
  #run_gcta = True
  run_relate = True
  run_tsinfer = True

def print_results(string):
  out_file = open(name, "a")
  out_file.write(str(string) + "\n")
  out_file.close()

def print_logs(string):
  out_file = open(name + ".log", "a")
  out_file.write(str(string) + "\n")
  out_file.close()

### run workflow
print_results(str(datetime.datetime.now()))
print_results(args)

print_logs("simulating ...")
simulation = simulate(**args)

trees = simulation["hapdata"]["tree_sequence"]
N = simulation["parameters"]["N"]
M = simulation["hapdata"]["M"]
variants = simulation["hapdata"]["variants"]
M_cas = simulation["phenotypes"]["M_cas"]
M_obs = simulation["observations"]["M_obs"]
M_5 = simulation["observations"]["M_5"]
cass = simulation["phenotypes"]["cass"]
obss = simulation["observations"]["obss"]

if run_relate:
  print_logs("running relate ...")
  os.mkdir(name + "_relate")
  os.chdir(name + "_relate")
  write_relate(simulation, obss, "observed")
  
  relate("observed", name + ".log")
  trees_relate = tskit.load("observed.trees")
  os.chdir("..")
else:
  trees_relate = trees

if run_tsinfer:
  print_logs("running tsinfer ...")
  
  sample_data = tsinfer.SampleData(sequence_length = simulation["parameters"]["l"])
  for obs in obss:
    sample_data.add_site(variants[obs], simulation["hapdata"]["genotype_matrix"][obs, :])
  
  trees_tsinfer = tsinfer.infer(sample_data)
  trees_tsdate = tsdate.date(trees_tsinfer, Ne=10000, mutation_rate=1e-8)

diffs1 = np.array(compare(trees, trees_relate, 1000))
diffs2 = np.array(compare(trees, trees_tsinfer, 1000))
diffs3 = np.array(compare(trees, trees_tsdate, 1000))

print_results(str(diffs1.mean()) + "+-" + str(diffs1.std()))
print_results(str(diffs2.mean()) + "+-" + str(diffs2.std()))
print_results(str(diffs3.mean()) + "+-" + str(diffs3.std()))
print_results("\n" + str(datetime.datetime.now()))

### save
trees = simulation["hapdata"].pop("tree_sequence")
pickle.dump(simulation, open("{}.p".format(name), "wb"))
trees.dump("{}.trees".format(name))
